{#- ============================================================================
   DeepSeek-V3.2 DSML Chat Template
   Converted from encoding_dsv32.py encode_messages function.
   Uses DSML (DeepSeek Markup Language) format for tool calls.
   ============================================================================ -#}
{%- set bos_token = "<｜begin▁of▁sentence｜>" -%}
{%- set eos_token = "<｜end▁of▁sentence｜>" -%}
{%- set thinking_start_token = "" -%}
{%- set thinking_end_token = "" -%}
{%- set dsml_token = "｜DSML｜" -%}

{%- set system_msg_template = "{content}" -%}
{%- set user_msg_template = "<｜User｜>{content}<｜Assistant｜>" -%}
{%- set assistant_msg_template = "{reasoning}{content}{tool_calls}<｜end▁of▁sentence｜>" -%}
{%- set thinking_template = "{reasoning_content}" -%}
{%- set tool_call_template = "<{dsml_token}invoke name=\"{name}\">\n{arguments}\n{dsml_token}invoke>" -%}
{%- set tool_calls_template = "<{dsml_token}function_calls>\n{tool_calls}\n{dsml_token}function_calls>" -%}
{%- set tool_output_template = "\n{content}" -%}

{%- set TOOLS_SYSTEM_TEMPLATE -%}
## Tools
You have access to a set of tools you can use to answer the user's question.
You can invoke functions by writing a "<{{ dsml_token }}function_calls>" block like the following as part of your reply to the user:

<{{ dsml_token }}function_calls>
<{{ dsml_token }}invoke name="$FUNCTION_NAME">
<{{ dsml_token }}parameter name="$PARAMETER_NAME" string="true|false">$PARAMETER_VALUE{{ dsml_token }}parameter>
...
{{ dsml_token }}invoke>
<{{ dsml_token }}invoke name="$FUNCTION_NAME2">
...
{{ dsml_token }}invoke>
{{ dsml_token }}function_calls>

String and scalar parameters should be specified as is without any escaping or quotes, while lists and objects should use JSON format. The "string" attribute should be set to "true" for string type parameters and "false" for other types (numbers, booleans, arrays, objects).

Here are the functions available in JSONSchema format:
{tool_schemas}
{%- endset -%}

{%- if thinking_mode is not defined -%}
  {%- set thinking_mode = "thinking" -%}
{%- endif -%}
{%- if drop_thinking is not defined -%}
  {%- set drop_thinking = true -%}
{%- endif -%}
{%- if add_default_bos_token is not defined -%}
  {%- set add_default_bos_token = true -%}
{%- endif -%}

{#- Macro: encode_arguments_to_dsml -#}
{%- macro encode_arguments_to_dsml(arguments) -%}
  {%- set ns = namespace(P_dsml_strs=[]) -%}
  {%- if arguments is mapping -%}
    {%- for k, v in arguments.items() -%}
      {%- if v is string -%}
        {%- set is_str = "true" -%}
        {%- set value = v -%}
      {%- else -%}
        {%- set is_str = "false" -%}
        {%- set value = v | tojson -%}
      {%- endif -%}
      {%- set p_dsml_str = "<" ~ dsml_token ~ "parameter name=\"" ~ k ~ "\" string=\"" ~ is_str ~ "\">" ~ value ~ dsml_token ~ "parameter>" -%}
      {%- set ns.P_dsml_strs = ns.P_dsml_strs + [p_dsml_str] -%}
    {%- endfor -%}
  {%- endif -%}
  {{- ns.P_dsml_strs | join("\n") -}}
{%- endmacro -%}

{#- Macro: render_tools -#}
{%- macro render_tools(tools) -%}
  {%- set ns = namespace(tools_json=[]) -%}
  {%- for tool in tools -%}
    {%- if tool.function is defined -%}
      {%- set ns.tools_json = ns.tools_json + [tool.function | tojson] -%}
    {%- else -%}
      {%- set ns.tools_json = ns.tools_json + [tool | tojson] -%}
    {%- endif -%}
  {%- endfor -%}
  {{- TOOLS_SYSTEM_TEMPLATE | replace("{tool_schemas}", ns.tools_json | join("\n")) }}
{% endmacro -%}

{#- Macro: find_last_user_index -#}
{%- macro find_last_user_index(messages) -%}
  {%- set ns = namespace(last_user_index=-1) -%}
  {%- for msg in messages -%}
    {%- set role = msg.role if msg.role is defined else msg.get('role') -%}
    {%- if role in ['user', 'developer'] -%}
      {%- set ns.last_user_index = loop.index0 -%}
    {%- endif -%}
  {%- endfor -%}
  {{- ns.last_user_index -}}
{%- endmacro -%}

{#- Macro: render_tool_calls_content -#}
{%- macro render_tool_calls_content(tool_calls) -%}
  {%- set ns = namespace(formatted_calls=[]) -%}
  {%- for tool_call in tool_calls -%}
    {%- if tool_call.function is defined -%}
      {%- set name = tool_call.function.name -%}
      {%- set arguments = tool_call.function.arguments -%}
    {%- else -%}
      {%- set name = tool_call.name -%}
      {%- set arguments = tool_call.arguments -%}
    {%- endif -%}
    {%- if arguments is string -%}
      {%- set arguments = arguments | fromjson -%}
    {%- endif -%}
    {%- set formatted_call = "<" ~ dsml_token ~ "invoke name=\"" ~ name ~ "\">\n" ~ encode_arguments_to_dsml(arguments) ~ "\n" ~ dsml_token ~ "invoke>" -%}
    {%- set ns.formatted_calls = ns.formatted_calls + [formatted_call] -%}
  {%- endfor -%}
  {{- "<" ~ dsml_token ~ "function_calls>\n" ~ ns.formatted_calls | join("\n") ~ "\n" ~ dsml_token ~ "function_calls>" -}}
{%- endmacro -%}

{#- Macro: render_message -#}
{%- macro render_message(index, messages, thinking_mode) -%}
  {%- set msg = messages[index] -%}
  {%- set last_user_idx = find_last_user_index(messages) | int -%}
  {%- set role = msg.role if msg.role is defined else msg.get('role') -%}
  {%- set content = msg.content if msg.content is defined else (msg.get('content', '') or '') -%}
  {%- set msg_tools = msg.tools if msg.tools is defined else msg.get('tools', []) -%}
  {%- set tool_calls = msg.tool_calls if msg.tool_calls is defined else msg.get('tool_calls', []) -%}
  {%- set reasoning_content = msg.reasoning_content if msg.reasoning_content is defined else (msg.get('reasoning_content', '') or '') -%}

  {%- if role == 'system' -%}
    {{- content or '' -}}
    {%- if msg_tools -%}
      {{- "\n\n" ~ render_tools(msg_tools) -}}
    {%- endif -%}

  {%- elif role == 'user' -%}
    {{- "<｜User｜>" ~ content ~ "<｜Assistant｜>" -}}
    {%- if index == last_user_idx and thinking_mode == "thinking" -%}
      {{- thinking_start_token -}}
    {%- else -%}
      {{- thinking_end_token -}}
    {%- endif -%}

  {%- elif role == 'tool' -%}
    {%- set ns = namespace(prev_assistant_idx=-1) -%}
    {%- for i in range(index - 1, -1, -1) -%}
      {%- set check_role = messages[i].role if messages[i].role is defined else messages[i].get('role') -%}
      {%- if check_role != 'tool' and ns.prev_assistant_idx == -1 -%}
        {%- set ns.prev_assistant_idx = i -%}
      {%- endif -%}
    {%- endfor -%}
    {%- set tool_call_order = index - ns.prev_assistant_idx -%}
    {%- set assistant_msg = messages[ns.prev_assistant_idx] -%}
    {%- set assistant_tool_calls = assistant_msg.tool_calls if assistant_msg.tool_calls is defined else assistant_msg.get('tool_calls', []) -%}
    {%- if tool_call_order == 1 -%}
      {{- "\n\n" -}}
    {%- endif -%}
    {{- "\n" ~ content -}}
    {%- if tool_call_order == (assistant_tool_calls | length) -%}
      {{- "\n" -}}
      {%- if index >= last_user_idx and thinking_mode == "thinking" -%}
        {{- "\n\n" ~ thinking_start_token -}}
      {%- else -%}
        {{- "\n\n" ~ thinking_end_token -}}
      {%- endif -%}
    {%- endif -%}

  {%- elif role == 'assistant' -%}
    {%- set ns = namespace(thinking_part="", tool_calls_content="") -%}
    {%- if tool_calls -%}
      {%- set ns.tool_calls_content = "\n\n" ~ render_tool_calls_content(tool_calls) -%}
    {%- endif -%}
    {%- set summary_content = content or "" -%}
    {%- if thinking_mode == "thinking" and index > last_user_idx -%}
      {%- set ns.thinking_part = reasoning_content ~ thinking_end_token -%}
    {%- endif -%}
    {{- ns.thinking_part ~ summary_content ~ ns.tool_calls_content ~ "<｜end▁of▁sentence｜>" -}}
  {%- endif -%}
{%- endmacro -%}

{#- Main template body -#}
{%- set full_messages = messages -%}

{#- Handle tools in top-level (OpenAI format) -#}
{%- if tools is defined and tools is not none -%}
  {%- set ns_sys = namespace(has_system=false, sys_idx=-1) -%}
  {%- for msg in full_messages -%}
    {%- set role = msg.role if msg.role is defined else msg.get('role') -%}
    {%- if role == 'system' and not ns_sys.has_system -%}
      {%- set ns_sys.has_system = true -%}
      {%- set ns_sys.sys_idx = loop.index0 -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}

{%- if add_default_bos_token -%}
  {{- bos_token -}}
{%- endif -%}

{#- If tools defined at top level but no system message has them, prepend tools info -#}
{%- if tools is defined and tools is not none -%}
  {{- render_tools(tools) -}}
{%- endif -%}

{%- for msg in full_messages -%}
  {{- render_message(loop.index0, full_messages, thinking_mode) -}}
{%- endfor -%}
